<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="彤哥哥的博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://ltyeamin.github.io">
    <!--SEO-->

    <meta name="keywords" content="Spring Cloud">


    <meta name="description" content="最近在做项目优化,研究了Spring Cloud底层源码,Http请求库默认是Apache HttpClient或者JDK自带的HttpURLConnection库.Java标准库提供了Http...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->


<title>Spring Cloud-使用高性能的OkHttp库 | 彤哥哥的博客</title>


    <link rel="alternate" href="/atom.xml" title="彤哥哥的博客" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">


<script src="/js/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">
<link rel="stylesheet" href="/css/calendar.css?rev=@@hash">
<link rel="stylesheet" href="/css/variable.css?rev=@@hash">
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ebfd000c0e7cc1ee84a00f01d419b1e2";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header" style="background-image:url(http://snippet.shenliyang.com/img/banner.jpg)">
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="YeaMin">
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                 <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://ltyeamin.github.io">彤哥哥的博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa"></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/backend/"><i class="fa"></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/frontend/"><i class="fa"></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/ops/"><i class="fa"></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/database/"><i class="fa"></i>数据库</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/algorithm/"><i class="fa"></i>算法</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/pm/"><i class="fa"></i>项目管理</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href=""><i class="fa"></i>自媒体</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/others/"><i class="fa"></i>生活</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/about"><i class="fa /favicon.ico"></i>关于</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Spring Cloud-使用高性能的OkHttp库">
            
	            Spring Cloud-使用高性能的OkHttp库
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/backend/">backend</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/Spring-Cloud/">Spring Cloud</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/01/30</span>
        </span>
        
            <span class="fa-wrap">
                <i class="fa fa-eye"></i>
                <span id="busuanzi_value_page_pv"></span>
            </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>760</strong>天之前发表，文中内容可能已经过时
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>最近在做项目优化,研究了Spring Cloud底层源码,Http请求库默认是Apache HttpClient或者JDK自带的HttpURLConnection库.Java标准库提供了HttpURLConnection类来支持HTTP通讯。不过HttpURLConnection本身的API不够友好，所提供的功能也有限。大部分Java程序都选择使用Apache的开源项目HttpClient作为HTTP客户端。ApacheHttpClient库的功能强大，使用率也很高，基本上是Java平台中事实上的标准HTTP客户端,但是做Android的小伙伴早已经淘汰该库了,就是因为其API数量过多过于繁重,使得我们很难在不破坏兼容性的情况下对它进行升级和扩展,因而团队不愿意去维护该库.本章介绍的是由 Square 公司开发的OkHttp，是一个专注于性能和易用性的 HTTP 客户端。<br>OkHttp 库的设计和实现的首要目标是高效.支持SPDY,,可以合并多个到同一个主机的请求, 使用连接池技术减少请求的延迟(如果SPDY是可用的话),使用GZIP压缩减少传输的数据量,缓存响应避免重复的网络请求,当网络出现问题时，OkHttp 会自动重试一个主机的多个IP地址。</p>
<h2 id="OkHttp在Zuul中的应用"><a href="#OkHttp在Zuul中的应用" class="headerlink" title="OkHttp在Zuul中的应用"></a>OkHttp在Zuul中的应用</h2><p>话说至此,有些人可能又疑问?我怎么知道默认底层用的是的Apache Client?<br>我在公司负责Zuul网关模块,Zuul的动态路由转发用Ribbon调用.查看官方文档,如下:</p>
<blockquote>
<p>19.3 Zuul Http Client<br>The default HTTP client used by zuul is now backed by the Apache HTTP Client instead of the deprecated Ribbon RestClient. To use RestClient or to use the okhttp3.OkHttpClient set ribbon.restclient.enabled=true or ribbon.okhttp.enabled=true respectively. If you would like to customize the Apache HTTP client or the OK HTTP client provide a bean of type ClosableHttpClient or OkHttpClient.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">参照上述官方文档说明,解决方案已经明了,具体实施如下:</span><br><span class="line">1.确保你的项目有okhttp依赖:</span><br><span class="line">&lt;!-- OkHttp --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;okhttp&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<ol start="2">
<li><p>application.yml添加ribbon配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ribbon:</span><br><span class="line">  httpclient:</span><br><span class="line">     enabled: false # 默认开启需要禁用</span><br><span class="line">  okhttp:</span><br><span class="line">     enabled: true</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试替换是否成功<br>a,将GateWay服务日志设置为DEBUG模式进行调用,查看日志会有许多有关OkHttp的东西,但日志打印太多,不易捕获,不易观察</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">RibbonCommandFactoryConfiguration.HttpClientRibbonConfiguration matched:</span><br><span class="line"></span><br><span class="line">- AnyNestedCondition 1 matched 1 did not; NestedCondition on RibbonCommandFactoryConfiguration.OnRibbonHttpClientCondition.RibbonProperty@ConditionalOnProperty</span><br><span class="line"> (ribbon.httpclient.enabled) found different value in property &apos;ribbon.httpclient.enabled&apos;; NestedCondition on RibbonCommandFactoryConfiguration.OnRibbonHttpClientCondition.ZuulProperty @ConditionalOnProperty</span><br><span class="line"> (zuul.ribbon.httpclient.enabled) matched (RibbonCommandFactoryConfiguration.OnRibbonHttpClientCondition)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RibbonCommandFactoryConfiguration.OkHttpRibbonConfigurationmatched:</span><br><span class="line"></span><br><span class="line">-@ConditionalOnClass found required class &apos;okhttp3.OkHttpClient&apos;;</span><br><span class="line"> @ConditionalOnMissingClass did not find unwanted class (OnClassCondition)</span><br><span class="line"></span><br><span class="line">- AnyNestedCondition 1 matched 1 did not; NestedCondition on RibbonCommandFactoryConfiguration.OnRibbonOkHttpClientCondition.RibbonProperty@ConditionalOnProperty</span><br><span class="line"> (ribbon.okhttp.enabled) matched; NestedCondition on RibbonCommandFactoryConfiguration.OnRibbonOkHttpClientCondition.ZuulProperty @ConditionalOnProperty (zuul.ribbon.okhttp.enabled) did not find</span><br><span class="line"> property &apos;zuul.ribbon.okhttp.enabled&apos; (RibbonCommandFactoryConfiguration.OnRibbonOkHttpClientCondition)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>b,Debug启动GateWay服务,通过源码方式查看RibbonCommandFactoryConfiguration实际配置的Http客户端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">package org.springframework.cloud.netflix.zuul;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.Documented;</span><br><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.autoconfigure.condition.AnyNestedCondition;</span><br><span class="line">import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line">import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line">import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line">import org.springframework.cloud.netflix.ribbon.SpringClientFactory;</span><br><span class="line">import org.springframework.cloud.netflix.zuul.filters.ZuulProperties;</span><br><span class="line">import org.springframework.cloud.netflix.zuul.filters.route.RestClientRibbonCommandFactory;</span><br><span class="line">import org.springframework.cloud.netflix.zuul.filters.route.RibbonCommandFactory;</span><br><span class="line">import org.springframework.cloud.netflix.zuul.filters.route.ZuulFallbackProvider;</span><br><span class="line">import org.springframework.cloud.netflix.zuul.filters.route.apache.HttpClientRibbonCommandFactory;</span><br><span class="line">import org.springframework.cloud.netflix.zuul.filters.route.okhttp.OkHttpRibbonCommandFactory;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Conditional;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Dave Syer</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class RibbonCommandFactoryConfiguration &#123;</span><br><span class="line"></span><br><span class="line">	@Configuration</span><br><span class="line">	@ConditionalOnRibbonRestClient</span><br><span class="line">	protected static class RestClientRibbonConfiguration &#123;</span><br><span class="line"></span><br><span class="line">		@Autowired(required = false)</span><br><span class="line">		private Set&lt;ZuulFallbackProvider&gt; zuulFallbackProviders = Collections.emptySet();</span><br><span class="line"></span><br><span class="line">		@Bean</span><br><span class="line">		@ConditionalOnMissingBean</span><br><span class="line">		public RibbonCommandFactory&lt;?&gt; ribbonCommandFactory(</span><br><span class="line">				SpringClientFactory clientFactory, ZuulProperties zuulProperties) &#123;</span><br><span class="line">			return new RestClientRibbonCommandFactory(clientFactory, zuulProperties,</span><br><span class="line">					zuulFallbackProviders);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Configuration</span><br><span class="line">	@ConditionalOnRibbonOkHttpClient</span><br><span class="line">	@ConditionalOnClass(name = &quot;okhttp3.OkHttpClient&quot;)</span><br><span class="line">	protected static class OkHttpRibbonConfiguration &#123;</span><br><span class="line"></span><br><span class="line">		@Autowired(required = false)</span><br><span class="line">		private Set&lt;ZuulFallbackProvider&gt; zuulFallbackProviders = Collections.emptySet();</span><br><span class="line"></span><br><span class="line">		@Bean</span><br><span class="line">		@ConditionalOnMissingBean</span><br><span class="line">		public RibbonCommandFactory&lt;?&gt; ribbonCommandFactory(</span><br><span class="line">				SpringClientFactory clientFactory, ZuulProperties zuulProperties) &#123;</span><br><span class="line">			return new OkHttpRibbonCommandFactory(clientFactory, zuulProperties,</span><br><span class="line">					zuulFallbackProviders);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Configuration</span><br><span class="line">	@ConditionalOnRibbonHttpClient</span><br><span class="line">	protected static class HttpClientRibbonConfiguration &#123;</span><br><span class="line"></span><br><span class="line">		@Autowired(required = false)</span><br><span class="line">		private Set&lt;ZuulFallbackProvider&gt; zuulFallbackProviders = Collections.emptySet();</span><br><span class="line"></span><br><span class="line">		@Bean</span><br><span class="line">		@ConditionalOnMissingBean</span><br><span class="line">		public RibbonCommandFactory&lt;?&gt; ribbonCommandFactory(</span><br><span class="line">				SpringClientFactory clientFactory, ZuulProperties zuulProperties) &#123;</span><br><span class="line">			return new HttpClientRibbonCommandFactory(clientFactory, zuulProperties, zuulFallbackProviders);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Target(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span><br><span class="line">	@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">	@Documented</span><br><span class="line">	@Conditional(OnRibbonHttpClientCondition.class)</span><br><span class="line">	@interface ConditionalOnRibbonHttpClient &#123; &#125;</span><br><span class="line"></span><br><span class="line">	private static class OnRibbonHttpClientCondition extends AnyNestedCondition &#123;</span><br><span class="line">		public OnRibbonHttpClientCondition() &#123;</span><br><span class="line">			super(ConfigurationPhase.PARSE_CONFIGURATION);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		@Deprecated //remove in Edgware&quot;</span><br><span class="line">		@ConditionalOnProperty(name = &quot;zuul.ribbon.httpclient.enabled&quot;, matchIfMissing = true)</span><br><span class="line">		static class ZuulProperty &#123;&#125;</span><br><span class="line"></span><br><span class="line">		@ConditionalOnProperty(name = &quot;ribbon.httpclient.enabled&quot;, matchIfMissing = true)</span><br><span class="line">		static class RibbonProperty &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Target(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span><br><span class="line">	@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">	@Documented</span><br><span class="line">	@Conditional(OnRibbonOkHttpClientCondition.class)</span><br><span class="line">	@interface ConditionalOnRibbonOkHttpClient &#123; &#125;</span><br><span class="line"></span><br><span class="line">	private static class OnRibbonOkHttpClientCondition extends AnyNestedCondition &#123;</span><br><span class="line">		public OnRibbonOkHttpClientCondition() &#123;</span><br><span class="line">			super(ConfigurationPhase.PARSE_CONFIGURATION);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		@Deprecated //remove in Edgware&quot;</span><br><span class="line">		@ConditionalOnProperty(&quot;zuul.ribbon.okhttp.enabled&quot;)</span><br><span class="line">		static class ZuulProperty &#123;&#125;</span><br><span class="line"></span><br><span class="line">		@ConditionalOnProperty(&quot;ribbon.okhttp.enabled&quot;)</span><br><span class="line">		static class RibbonProperty &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Target(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span><br><span class="line">	@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">	@Documented</span><br><span class="line">	@Conditional(OnRibbonRestClientCondition.class)</span><br><span class="line">	@interface ConditionalOnRibbonRestClient &#123; &#125;</span><br><span class="line"></span><br><span class="line">	private static class OnRibbonRestClientCondition extends AnyNestedCondition &#123;</span><br><span class="line">		public OnRibbonRestClientCondition() &#123;</span><br><span class="line">			super(ConfigurationPhase.PARSE_CONFIGURATION);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		@Deprecated //remove in Edgware&quot;</span><br><span class="line">		@ConditionalOnProperty(&quot;zuul.ribbon.restclient.enabled&quot;)</span><br><span class="line">		static class ZuulProperty &#123;&#125;</span><br><span class="line"></span><br><span class="line">		@ConditionalOnProperty(&quot;ribbon.restclient.enabled&quot;)</span><br><span class="line">		static class RibbonProperty &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>解读:我们很清楚Zuul的负载均衡实现就通过Ribbon的实现,所以Http客户端的配置自然也是对Ribbon组件的配置,源代码中很明显都是通过@Conditional实现了条件加载,其中该类提供了不止一种的Http客户端(RestClient,默认的HttpClient,OkhttpClient)配置实现.要想确保改造成功,则需要在其内部类OkHttpRibbonConfiguration中的RibbonCommandFactory打上端点,看有没有进即可.</p>
<h2 id="Feign中Okhttp应用"><a href="#Feign中Okhttp应用" class="headerlink" title="Feign中Okhttp应用"></a>Feign中Okhttp应用</h2><p>大家也都知道Fegin的底层也是Ribbon,上述方式可以解决,但是更推荐Feign端开始解决.</p>
<ol>
<li><p>首先在服务调用方加入以下依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- feign整合OkHttp --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;feign-okhttp&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在application.yml文件配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">  httpclient:</span><br><span class="line">      enabled: false</span><br><span class="line">  okhttp:</span><br><span class="line">      enabled: true</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试是否配置成功<br>a, 启动服务进行接口调用,可以分析日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[2018-01-30 13:04:03.398] [DEBUG] [restartedMain] o.s.c.e.PropertySourcesPropertyResolver -Found</span><br><span class="line"> key &apos;feign.okhttp.enabled&apos; in [applicationConfigurationProperties] with type [String]</span><br><span class="line"></span><br><span class="line">[2018-01-30 13:04:03.398] [DEBUG] [restartedMain] o.s.b.f.s.DefaultListableBeanFactory - Returning cached instance of singleton bean</span><br><span class="line"> &apos;autoConfigurationReport&apos;</span><br><span class="line"></span><br><span class="line">[2018-01-30 13:04:03.398] [DEBUG] [restartedMain] o.s.c.a.ConfigurationClassBeanDefinitionReader - Registered bean definition for imported</span><br><span class="line"> class &apos;org.springframework.cloud.netflix.feign.ribbon.FeignRibbonClientAutoConfiguration$OkHttpFeignLoadBalancedConfiguration&apos;</span><br><span class="line"></span><br><span class="line">[2018-01-30 13:04:03.399] [DEBUG] [restartedMain] o.s.b.f.s.DefaultListableBeanFactory - Returning cached instance of singleton bean</span><br><span class="line"> &apos;org.springframework.boot.autoconfigure.condition.BeanTypeRegistry&apos;</span><br><span class="line"></span><br><span class="line">[2018-01-30 13:04:03.399] [DEBUG] [restartedMain] o.s.b.f.s.DefaultListableBeanFactory - Returning cached instance of singleton bean</span><br><span class="line"> &apos;org.springframework.boot.autoconfigure.condition.BeanTypeRegistry&apos;</span><br><span class="line"></span><br><span class="line">[2018-01-30 13:04:03.399] [DEBUG] [restartedMain] o.s.b.f.s.DefaultListableBeanFactory - Returning cached instance of singleton bean</span><br><span class="line"> &apos;autoConfigurationReport&apos;</span><br><span class="line"></span><br><span class="line">[2018-01-30 13:04:03.399] [DEBUG] [restartedMain] o.s.c.a.ConfigurationClassBeanDefinitionReader -Registering</span><br><span class="line"> bean definition for @Bean method org.springframework.cloud.netflix.feign.ribbon.FeignRibbonClientAutoConfiguration$OkHttpFeignLoadBalancedConfigur</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如上述日志文件Found key ‘feign.okhttp.enabled’可以看出替换成功.<br>b, 分析调用源码来测试是否成功替换成Okhttp<br>其自动装配源码在FeignRibbonClientAutoConfiguration中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@ConditionalOnClass(&#123; ILoadBalancer.class, Feign.class &#125;)</span><br><span class="line">@Configuration</span><br><span class="line">@AutoConfigureBefore(FeignAutoConfiguration.class)</span><br><span class="line">//Order is important here, last should be the default, first should be optional</span><br><span class="line">@Import(&#123; HttpClientFeignLoadBalancedConfiguration.class,</span><br><span class="line">		OkHttpFeignLoadBalancedConfiguration.class,</span><br><span class="line">		DefaultFeignLoadBalancedConfiguration.class &#125;)</span><br><span class="line">public class FeignRibbonClientAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnMissingBean</span><br><span class="line">    public Client feignClient(CachingSpringLoadBalancerFactory cachingFactory,</span><br><span class="line">            SpringClientFactory clientFactory) &#123;</span><br><span class="line">	    //Feign默认的客户端是Client.Default</span><br><span class="line">        return new LoadBalancerFeignClient(new Client.Default(null, null),</span><br><span class="line">                cachingFactory, clientFactory);</span><br><span class="line">    &#125;</span><br><span class="line">	 //省略类中的内容...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从该类中的注释可以看出,DefaultFeignLoadBalancedConfiguration.class是默认配置,HttpClientFeignLoadBalancedConfiguration.class是可选的.<br>Debug启动服务并进行远程Feign的一路调用发现,会走如下的方法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">final class SynchronousMethodHandler implements MethodHandler &#123;</span><br><span class="line"></span><br><span class="line"> @Override</span><br><span class="line">  public Object invoke(Object[] argv) throws Throwable &#123;</span><br><span class="line">    RequestTemplate template = buildTemplateFromArgs.create(argv);</span><br><span class="line">    Retryer retryer = this.retryer.clone();</span><br><span class="line">    while (true) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        return executeAndDecode(template);</span><br><span class="line">      &#125; catch (RetryableException e) &#123;</span><br><span class="line">        retryer.continueOrPropagate(e);</span><br><span class="line">        if (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">          logger.logRetry(metadata.configKey(), logLevel);</span><br><span class="line">        &#125;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Object executeAndDecode(RequestTemplate template) throws Throwable &#123;</span><br><span class="line">    Request request = targetRequest(template);</span><br><span class="line"></span><br><span class="line">    if (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">      logger.logRequest(metadata.configKey(), logLevel, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Response response;</span><br><span class="line">    long start = System.nanoTime();</span><br><span class="line">    try &#123;</span><br><span class="line">      response = client.execute(request, options);</span><br><span class="line">      // ensure the request is set. TODO: remove in Feign 10</span><br><span class="line">      response.toBuilder().request(request).build();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">      if (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">        logger.logIOException(metadata.configKey(), logLevel, e, elapsedTime(start));</span><br><span class="line">      &#125;</span><br><span class="line">      throw errorExecuting(request, e);</span><br><span class="line">    &#125;</span><br><span class="line">    //省略代码......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们发现SynchronousMethodHandler中的invoke()方法又去调用executeAndDecode()方法,在执行下列一段代码的时候,你会发现到底是用哪个Http客户端进行调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = client.execute(request, options);</span><br></pre></td></tr></table></figure></p>
<p>Client是Feign的Client接口声明,这时候会有好几个实现:Default,LoadBalancerFeignClinet,OkHttpClient,TraceFeignClient.<br>这下明显了,如果你的classpath下有okhttp的依赖,则会走feign.okhttp.OkHttpClient.execute()方法,如果没有依赖,就会走feign.Client.Default.execute()方法.<br>okhttp没什么说的,可以看一下默认的Feign Client - Default中的execute()代码片段:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public Response execute(Request request, Options options) throws IOException &#123;</span><br><span class="line">     HttpURLConnection connection = convertAndSend(request, options);</span><br><span class="line">     return convertResponse(connection).toBuilder().request(request).build();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>由上面代码片段可以得出,Spring Cloud默认Feign的客户端是HttpURLConnection构建的.<br>需要注意的是,无论Feign是哪种Client,默认都是开启的,重点在于classpath下的依赖,而不是application.yml里的开关配置.之所以配置开关是因为关闭掉无用的Client.</p>
<h2 id="默认配置解说"><a href="#默认配置解说" class="headerlink" title="默认配置解说"></a>默认配置解说</h2><p>Feign 读取时间配置：<br>默认读取连接时间10s,默认连接读取时间60s<br>源码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public final class Request &#123;</span><br><span class="line"></span><br><span class="line">	 public static class Options &#123; </span><br><span class="line"></span><br><span class="line">	 	private final int connectTimeoutMillis;</span><br><span class="line">   		private final int readTimeoutMillis;</span><br><span class="line"></span><br><span class="line">	    public Options(int connectTimeoutMillis, int readTimeoutMillis) &#123;</span><br><span class="line">	      this.connectTimeoutMillis = connectTimeoutMillis;</span><br><span class="line">	      this.readTimeoutMillis = readTimeoutMillis;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">        //默认构造器时间</span><br><span class="line">	 	public Options() &#123;</span><br><span class="line">      		this(10 * 1000, 60 * 1000);</span><br><span class="line">    	&#125;</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>手动设置默认的读取时间和连接时间:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public Request.Options options() &#123;</span><br><span class="line">	 Request.Options options = new  Request.Options(5 * 1000, 5 * 1000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>手动配置Okhttp3<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ConditionalOnClass(Feign.class)</span><br><span class="line">@AutoConfigureBefore(FeignAutoConfiguration.class)</span><br><span class="line">public class FeignOkHttpConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    OkHttpLoggingInterceptor okHttpLoggingInterceptor;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public okhttp3.OkHttpClient okHttpClient()&#123;</span><br><span class="line">        return new okhttp3.OkHttpClient.Builder()</span><br><span class="line">            .readTimeout(60, TimeUnit.SECONDS)  //设置读取超时时间</span><br><span class="line">            .connectTimeout(60, TimeUnit.SECONDS) //设置连接超时时间</span><br><span class="line">            .writeTimeout(120, TimeUnit.SECONDS) </span><br><span class="line">            .connectionPool(new ConnectionPool())</span><br><span class="line">            // .addInterceptor();  //添加请求拦截器</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考文献:<br><a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR1/single/spring-cloud.html" target="_blank" rel="noopener">官方文档</a><br><a href="http://blog.springcloud.cn/sc/sc-feign-4xx/" target="_blank" rel="noopener">Feign产生的问题</a><br><a href="http://blog.springcloud.cn/sc/sc-w-feign/" target="_blank" rel="noopener">Feign源码解读</a></p>
    </div>
    
        <div class="reward" ontouchstart="">
    <div class="reward-wrap">赏
        <div class="reward-box">
            
                <span class="reward-type">
                    <img class="alipay" src="/about/alipay.png"><b>支付宝打赏</b>
                </span>
            
            
                <span class="reward-type">
                    <img class="wechat" src="/about/weixin.png"><b>微信打赏</b>
                </span>
            
        </div>
    </div>
    <p class="reward-tip">请作者喝杯咖啡吧</p>

    <!-- 社会分享工具 -->
    <div class="bdsharebuttonbox">
         <a href="#" class="bds_more" data-cmd="more"></a>
         <a href="#" class="bds_qzone" data-cmd="qzone"></a><a href="#" class="bds_tsina" data-cmd="tsina"></a>
         <a href="#" class="bds_tqq" data-cmd="tqq"></a><a href="#" class="bds_renren" data-cmd="renren"></a>
         <a href="#" class="bds_weixin" data-cmd="weixin"></a>
    </div>
     <script>
        window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdPic":"","bdStyle":"0","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
     </script>
</div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">彤哥哥</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2018/01/30/浅谈匿名函数,Lambda,闭包(Closure)/" class="pre-post btn btn-default" title="浅谈匿名函数,Lambda和闭包(Closure)">
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">浅谈匿名函数,Lambda和闭包(Closure)</span>
        </a>
    
    
        <a href="/2017/12/15/ES6新的数据类型-generator/" class="next-post btn btn-default" title="ES6新的数据类型-generator">
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">ES6新的数据类型-generator</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: 'wA3iNQOiAuhrRJkNgIjirA8f-gzGzoHsz',
            appKey: 'iGL0JyEnJQ8HIMlLd4Sm0oOp',
            placeholder: '说点什么吧',
            notify: false,
            verify: false,
            avatar: 'mm',
            meta: 'nick,mail,link'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>
    </div>
                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#OkHttp在Zuul中的应用"><span class="toc-text">OkHttp在Zuul中的应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign中Okhttp应用"><span class="toc-text">Feign中Okhttp应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#默认配置解说"><span class="toc-text">默认配置解说</span></a></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
        访问量:
        <strong id="busuanzi_value_site_pv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
        &nbsp; | &nbsp;
        访客数:
        <strong id="busuanzi_value_site_uv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
    
</div>
            </div>
            <div>
                <!-- 服务器运行时间统计 -->
                <span id="sitetime"></span>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019
                </span> |
                <span>
                    Powered by <a href="//ltyeamin.github.io" class="copyright-links" target="_blank" rel="nofollow">litong</a>
                </span> |
                <span>
                    Blog by <a href="//ltyeamin.github.io" class="copyright-links" target="_blank" rel="nofollow">彤哥哥</a>
                </span>
            </div>
        </div>
    </div>
</div>


<script src="/assets/tagcanvas.min.js?rev=2.9"></script>
    <script>
        var tagOption = {
            textColour: '#e67e22', // 字体颜色
            outlineMethod: 'block', // 选中模式
            outlineColour: '  #FDF5E6', // 选中模式的颜色
            interval: 30 || 30, // 动画帧之间的时间间隔，值越大，转动幅度越大
            textHeight: 13,
            outlineRadius: 3,
            freezeActive: true || '', // 选中的标签是否继续滚动
            frontSelect: true || '', // 不选标签云后部的标签
            initial: [0.1, -0.1],
            depth: 0.5,
            decel: 0.95,
            maxSpeed: 0.03,
            reverse: true || '', // 是否反向触发
            fadeIn: 500, // 进入动画时间
            wheelZoom: true || '' // 是否启用鼠标滚轮
        }
        TagCanvas.Start('tag-cloud-3d','',tagOption);
    </script>



    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash"></script>
<!-- 页面点击小红心，在末尾添加，避免找不到 -->
<script type="text/javascript" src="/js/love.js"></script>

<!-- DaoVoice即时通讯工具 -->

 <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "10b503a1"
    });
  daovoice('update');
  </script>


<!-- 音频播放 
<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>
-->

<!-- 服务器运行时间统计 -->
<script language="javascript">
        function siteTime(){
          window.setTimeout("siteTime()", 1000);
          var seconds = 1000;
          var minutes = seconds * 60;
          var hours = minutes * 60;
          var days = hours * 24;
          var years = days * 365;
          var today = new Date();
          var todayYear = today.getFullYear();
          var todayMonth = today.getMonth()+1;
          var todayDate = today.getDate();
          var todayHour = today.getHours();
          var todayMinute = today.getMinutes();
          var todaySecond = today.getSeconds();
          /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
          year - 作为date对象的年份，为4位年份值
          month - 0-11之间的整数，做为date对象的月份
          day - 1-31之间的整数，做为date对象的天数
          hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
          minutes - 0-59之间的整数，做为date对象的分钟数
          seconds - 0-59之间的整数，做为date对象的秒数
          microseconds - 0-999之间的整数，做为date对象的毫秒数 */
          var t1 = Date.UTC(2016,12,1,00,00,00); //北京时间2016-12-1 00:00:00
          var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
          var diff = t2-t1;
          var diffYears = Math.floor(diff/years);
          var diffDays = Math.floor((diff/days)-diffYears*365);
          var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
          var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
          var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
          document.getElementById("sitetime").innerHTML=" 本站已运行 "+ diffYears+" 年 "+ diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分 "+diffSeconds+" 秒";
        }
        siteTime();
</script>
</body>
